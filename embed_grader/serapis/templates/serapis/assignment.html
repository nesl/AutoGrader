{% extends 'serapis/base_sidebar.html' %}
{% load staticfiles %}
{% load guardian_tags %}
{% load submission_tags %}

{% block sidebar-content %}
    <!-- SIDEBAR USER TITLE -->
    <div class="profile-usertitle">
        <div class="profile-usertitle-name">
            {{ course.course_code }}
        </div>
        <div class="profile-usertitle-job">
            {{ assignment.name }}
        </div>
    </div>
    <!-- END SIDEBAR USER TITLE -->
    <!-- SIDEBAR MENU -->
    <div class="profile-usermenu">
        <ul class="nav nav-bar">
            <li>
                <a href="{% url 'homepage' %}">Courses</a>
            </li>
            {% get_obj_perms request.user for course as "course_perms" %}
            {% if "view_membership" in course_perms %}
            <li>
                <a href="{% url 'membership' course.id %}">Students</a>
            </li>
            {% endif %}
            {% if perms.serapis.view_hardware_type %}
            <li>
                <a data-toggle="collapse"
                data-target="#submenu1" aria-expanded="false">Submissions</a>
                <ul class="nav collapse" id="submenu1" role="menu" aria-labelledby="btn-1">
                  <li><a href="{% url 'submissions_full_log' %}">My Submissions</a></li>
                  <li><a href="{% url 'student_submission_full_log' %}">Student Submissions</a></li>
                </ul>
            </li>
            <li>
                <a href="{% url 'testbed-type-list' %}">Testbed Types</a>
            </li>
            <li>
                <a href="{% url 'hardware-type-list' %}">Hardware Types</a>
            </li>
            {% else %}
            <li>
                <a href="{% url 'submissions_full_log' %}">Submissions</a>
            </li>
            {% endif %}
        </ul>
    </div>
    <!-- END MENU -->
{% endblock %}

{% block main-content %}
  {% get_obj_perms request.user for course as "course_perms" %}
  
  <div class="main-content">
    <div class="top-buffer">
      <ol class="breadcrumb">
        <li><a href="{% url 'homepage' %}">Courses</a></li>
        <li><a href="{% url 'course' course.id %}">{{course.course_code}}</a></li>
        <li class="active">{{ assignment.name }}</a></li>
      </ol>
    </div>

    <h2 class="page-header">Assignment - {{ assignment.name }}</h2>

    <h3>Problem Statement</h3>
    <p>{{ assignment.problem_statement|safe }}</p>
    <hr/>

    <br/>
    <h3>Tasks (Sample: {{public_points}} points. Total: {{total_points}} points)</h3>
    <div class="table-responsive">
      <table class="table table-striped table-hover table-sm">
        <tr>
          <thead class="thead-default">
            {% if "modify_assignment" not in course_perms %}
              <th style="width:25%">Task</th>
              <th style="width:15%">Mode</th>
              <th style="width:10%">Points</th>
              <th style="width:35%">Description</th>
              <th style="width:15%">Input File</th>
            {% else %}
              <th style="width:15%">Task</th>
              <th style="width:12%">Mode</th>
              <th style="width:13%">Points</th>
              <th style="width:30%">Description</th>
              <th style="width:15%">Input File</th>
              <th style="width:15%">Edit</th>
            {% endif %}
          <thead>
        </tr>
        {% for task, file_list in assignment_tasks %}
          {% if "modify_assignment" not in course_perms %}
            <tr>
              <td>{{ task.brief_description }}</td>
              <td>{{ task.get_mode_display }}</td>
              <td>{{ task.points }}</td>
              <td>{{ task.description }}</td>
              <td>
                {% if submission_form %}
                  {% if task.get_mode_display == 'Public' or task.get_mode_display == 'Debug' %}
                  <a href="{{ MEDIA_URL }}{{ file_list.0 }}" class="btn btn-primary" 
                      style="font-size:12px; background:white; color:SteelBlue; border-color:SteelBlue;">
                    <span class="glyphicon glyphicon-download-alt"></span> &nbsp;Download   
                  </a>
                  {% else %}
                    N/A
                  {% endif %}
                {% else %}
                  <a href="{{ MEDIA_URL }}{{ file_list.0 }}" class="btn btn-primary" 
                      style="font-size:12px; background:white; color:SteelBlue; border-color:SteelBlue;">
                    <span class="glyphicon glyphicon-download-alt"></span> &nbsp;Download   
                  </a>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td>{{ task.brief_description }}</td>
              <td>{{ task.get_mode_display }}</td>
              <td>{{ task.points }}</td>
              <td>{{ task.description }}</td>
              <td>
                <a href="{{ MEDIA_URL }}{{ file_list.0 }}" class="btn btn-primary" 
                    style="font-size:12px; background:white; color:SteelBlue; border-color:SteelBlue;">
                  <span class="glyphicon glyphicon-download-alt"></span> &nbsp;Download   
                </a>
              </td>
              <td>
                <a href="{% url 'modify-assignment-task' task.id %}" class="btn btn-primary"
                    style="font-size: 12px; background:white; color:SteelBlue; border-color:SteelBlue;width:80px">
                  <span class="glyphicon glyphicon-edit"></span>&nbsp;Edit
                </a>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </table>
    </div>
    {% if "modify_assignment" in course_perms %}
      <a class="btn btn-primary" href="{% url 'create-assignment-task' assignment.id %}">Create New Task</a>
    {% endif %}

    <hr/>
    <br/>
    <h3/>Submit your code</h3>
    <hr/>
    <p><b>Release time: </b>{{ assignment.release_time }}</p>
    <p><b>Deadline: </b>{{ assignment.deadline }}</p>
    {% if submission_form %}
      <p><b>Time Remaining: </b>{{ time_remaining }}</p>
      <form action="." method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ submission_form.as_p }}
        <input class="btn btn-primary" type="submit" value="Submit" />
      </form>
    {% else %}
      <p style='color:red'>{{ reason_of_cannot_submit }}</p>
    {% endif %}

    <hr/>
    <h3>Real-time Score Distribution</h3>
    {% if not score_statistics %}
      <p>No students have tried this assignment so far.</p>
    {% else %}
      <p>{{num_contributed_students}} student(s) have tried this assignment so far</p>
      <p><span style="font-weight: bold;">Mean: </span>{{score_statistics.mean_score}}</p>
      <p><span style="font-weight: bold;">Highest Score: </span> {{score_statistics.max_score}}</p>
      <p><span style="font-weight: bold;">1st Quantile: </span> {{score_statistics.first_quantile}}</p>
      <p><span style="font-weight: bold;">Median: </span> {{score_statistics.median_score}}</p>
      <p><span style="font-weight: bold;">3rd Quantile: </span> {{score_statistics.third_quantile}}</p>
    {% endif %}

    <hr/>
    <br/>
    <h3>Recent Submissions</h3>

    {% if "modify_assignment" not in course_perms %}
      {% if not submission_lists.student %}
        <p>No submissions to this assignment yet.</p>
      {% else %}
        <table class="table table-striped table-hover table-sm">
          <tr><thead class="thead-default">
              {% submission_table_schema  status 30%  score 20%  submission_time 30%  detail_button 20% as table_schema %}
          </thead></tr>
          {% for submission in submission_lists.student %}
            <tr>{% submission_table_row table_schema submission myuser %}</tr>
          {% endfor %}
        </table>
      {% endif %} {# not submission_lists.student #}
    {% else %}
      {% if not submission_lists.grading and not submission_lists.graded %}
        <p>No submissions to this assignment yet.</p>
      {% else %}
        {% if submission_lists.graded %}
          <h4>Fully graded submissions</h4>
          <table class="table table-striped table-hover table-sm">
            <tr><thead class="thead-default">
              {% submission_table_schema  author_name 30%  score 20%  submission_time 30%  detail_button 20% as table_schema %}
            </thead></tr>
            {% for submission in submission_lists.graded %}
              <tr>{% submission_table_row table_schema submission myuser %}</tr>
            {% endfor %}
          </table>
        {% endif %}

        {% if submission_lists.grading %}
          <h4>Working submissions</h4>
          <table class="table table-striped table-hover table-sm">
            <tr><thead class="thead-default">
              {% submission_table_schema  author_name 22%  status 23%  score 15%  submission_time 25%  detail_button 15% as table_schema %}
            </thead></tr>
            {% for submission in submission_lists.grading %}
              <tr>{% submission_table_row table_schema submission myuser %}</tr>
            {% endfor %}
          </table>
        {% endif %}
      {% endif %} {# not submission_lists.grading and not submission_lists.graded #}

      <div>
        <a class="btn btn-primary" href="{% url 'regrade' assignment.id %}">Regrade interface</a>
      </div>
    {% endif %}

    <br/>
    <hr/>
    {% if "modify_assignment" not in course_perms %}
      <a class="btn btn-primary" href="{% url 'course' course.id %}" style="width:100px;">Back</a>
    {% else %}  
      <a class="btn btn-primary" href="{% url 'modify-assignment' assignment.id %}" style="width:100px;">
        <span class="glyphicon glyphicon-edit"></span>&nbsp; Edit </a>
      <a class="btn btn-primary" href="{% url 'course' course.id %}" style="width:100px; float:right;">Back</a>
    {% endif %}
  </div>
{% endblock %}
